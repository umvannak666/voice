<!DOCTYPE html>
<html lang="km">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>áŸá¶á€áŸá˜ááŸ’áá—á¶á–á¢á¶á“</title>
<style>
body { font-family:'Noto Sans Khmer',Arial,sans-serif; background:#c7ecee; padding:20px; }
.container { background:white; padding:25px 20px; border-radius:20px; max-width:480px; margin:auto; text-align:center; }
button { padding:10px 20px; margin:5px; border:none; border-radius:10px; cursor:pointer; background:#22a6b3; color:white; }
#result { min-height:50px; margin-top:15px; }
</style>
</head>
<body>
<div class="container">
<h2>áŸá¶á€áŸá˜ááŸ’áá—á¶á–á¢á¶á“ - User: {{ user }}</h2>
<p id="sentence"></p>
<button id="startBtn">ğŸ¤ á…á¶á”áŸ‹á•áŸ’áá¾á˜áŸáŸ’áá¶á”áŸ‹</button>
<button id="saveBtn" style="display:none;">ğŸ’¾ ášá€áŸ’áŸá¶á‘á»á€á›á‘áŸ’á’á•á›</button>
<p id="result"></p>

<audio id="cheerSound" src="https://www.soundjay.com/human/applause-01.mp3" preload="auto"></audio>
<audio id="wrongSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_1d3b8b1f39.mp3?filename=buzzer-126611.mp3" preload="auto"></audio>

<script>
const sentences = ['á˜áŸ‰áŸ‚','á”áŸ’ášá‡á¶á‡á“','áŸá¶á›á¶ášáŸ€á“','á–áŸ’ášáŸ‡áŸá„áŸ’áƒ'];
let index=0, scores=[], resultText="";
const sentenceEl=document.getElementById("sentence");
const resultEl=document.getElementById("result");
const startBtn=document.getElementById("startBtn");
const saveBtn=document.getElementById("saveBtn");
const cheerSound=document.getElementById("cheerSound");
const wrongSound=document.getElementById("wrongSound");

sentenceEl.textContent=sentences[index];

startBtn.addEventListener("click", ()=>{
    resultEl.textContent="á€áŸ†á–á»á„áŸáŸ’áá¶á”áŸ‹... ğŸ§";
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SpeechRecognition){ resultEl.textContent="Browser á˜á·á“á‚á¶áŸ†á‘áŸ’áš Web Speech API âŒ"; return; }
    const recognition = new SpeechRecognition();
    recognition.lang="km-KH"; recognition.interimResults=false;
    recognition.start();

    recognition.onresult=(event)=>{
        const spoken=event.results[0][0].transcript.trim();
        const targetWords=sentences[index].split(" ");
        const spokenWords=spoken.split(" ");
        let correct=0;
        for(let i=0;i<targetWords.length;i++){ if(targetWords[i]===spokenWords[i]) correct++; }
        const score=(correct/targetWords.length)*100;

        resultEl.innerHTML=`á¢áŸ’á“á€á”á¶á“á“á·á™á¶á™: <b>${spoken}</b><br>âœ… ááŸ’ášá¹á˜ ${correct}/${targetWords.length} (${score.toFixed(1)}%)<br>`;
        if(score===100){ resultEl.innerHTML+="<span style='color:green'>á›áŸ’á¢áá¶áŸáŸ‹! ğŸŒŸ</span>"; cheerSound.currentTime=0; cheerSound.play().catch(()=>{});}
        else if(score>=70){ resultEl.innerHTML+="<span style='color:orange'>á›áŸ’á¢! ááŸ’ášá¼áœá€áŸ‚á›á˜áŸ’á¢áá·á…</span>";}
        else{ resultEl.innerHTML+="<span style='color:red'>ááŸ’ášá¼áœá€áŸ‚á›á˜áŸ’á¢! âŒ</span>"; wrongSound.currentTime=0; wrongSound.play().catch(()=>{});}

        resultText+=`áŸáŸ†áá½áš: ${sentences[index]}\ná¢á¶á“: ${spoken}\ná–á·á“áŸ’á‘á»: ${score.toFixed(1)}%\n\n`;
        scores.push(score);

        setTimeout(()=>{
            index++;
            if(index<sentences.length){
                sentenceEl.textContent=sentences[index];
                resultEl.textContent="â¡ï¸ áŸá¼á˜á¢á¶á“á”áŸ’ášá™áŸ„á‚á”á“áŸ’á‘á¶á”áŸ‹...";
            } else{
                const avg=scores.reduce((a,b)=>a+b,0)/scores.length;
                sentenceEl.textContent="ğŸ‰ á¢áŸáŸ‹áŸáŸ†áá½áš!";
                resultEl.innerHTML=`<b>á›á‘áŸ’á’á•á›áŸášá»á”:</b><br>á–á·á“áŸ’á‘á»á˜á’áŸ’á™á˜á—á¶á‚ = ${avg.toFixed(1)}%<br>áŸáŸ†áá½áš = ${scores.length}`;
                const now=new Date();
                const timestamp=now.toLocaleString("km-KH",{hour12:false});
                resultText=`á›á‘áŸ’á’á•á›áŸá¶á€áŸá˜ááŸ’áá—á¶á–á¢á¶á“\nááŸ’á„áŸƒ-á˜áŸ‰áŸ„á„: ${timestamp}\n---------------------------\n\n`+resultText;
                resultText+=`ğŸ“Œ á›á‘áŸ’á’á•á›áŸášá»á”\ná˜á’áŸ’á™á˜á—á¶á‚: ${avg.toFixed(1)}%\náŸáŸ†áá½áš: ${scores.length}`;
                saveBtn.style.display="inline-block";
            }
        },2000);
    };
    recognition.onerror=()=>{ resultEl.textContent="á˜á·á“á¢á¶á…áŸáŸ’á‚á¶á›áŸ‹áŸáŸ†á¡áŸá„á”á¶á“ âŒ"; }
});

saveBtn.addEventListener("click",()=>{
    if(!resultText){ alert("á˜á·á“á˜á¶á“á›á‘áŸ’á’á•á›á‘áŸ"); return; }
    const htmlContent=`<!DOCTYPE html><html lang="km"><head><meta charset="UTF-8"><title>á›á‘áŸ’á’á•á›áŸá¶á€áŸá˜ááŸ’áá—á¶á–á¢á¶á“</title><style>body{font-family:'Noto Sans Khmer',Arial,sans-serif;padding:20px;background:#f5f6fa;}h1{color:#2d3436;}pre{background:#dfe6e9;padding:15px;border-radius:10px;overflow:auto;}</style></head><body><h1>á›á‘áŸ’á’á•á›áŸá¶á€áŸá˜ááŸ’áá—á¶á–á¢á¶á“</h1><pre>${resultText}</pre></body></html>`;
    const blob=new Blob([htmlContent],{type:"text/html"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download="reading_result.html";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});
</script>
</body>
</html>
